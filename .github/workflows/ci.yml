name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test
    runs-on: macos-15
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Show Xcode installations
      run: |
        ls -la /Applications/ | grep -i xcode
        echo "---"
        which xcodebuild
        xcodebuild -version

    - name: Show project files
      run: |
        pwd
        ls -la

    - name: Build and Test
      run: |
        xcodebuild \
          -project SubTrackr.xcodeproj \
          -scheme SubTrackr \
          -destination 'platform=iOS Simulator,name=iPhone 16 Pro Max,OS=18.5' \
          -derivedDataPath "$HOME/Library/Developer/Xcode/DerivedData-subtrackr" \
          -enableCodeCoverage YES \
          clean test

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: "$HOME/Library/Developer/Xcode/DerivedData-subtrackr/**/Logs/Test/*.xcresult"
        retention-days: 30

    - name: Generate code coverage report
      if: always()
      run: |
        XCRESULT=$(find $HOME/Library/Developer/Xcode/DerivedData-subtrackr -name "*.xcresult" -type d | head -n 1)
        if [ -n "$XCRESULT" ]; then
          xcrun xccov view --report --json "$XCRESULT" > coverage.json
        else
          echo "No .xcresult file found"
        fi
      continue-on-error: true

    - name: Upload coverage to Codecov
      if: always()
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.json
        flags: ios
        name: SubTrackr iOS Coverage
        fail_ci_if_error: false
